#!/usr/bin/perl

use strict;
use warnings;
use 5.010;

use Pod::Usage;

use constant {
	VERSION_NAME   => 'git-merge-sync',
	VERSION_NUMBER => '0.0.0',
};
use constant {
	VERSION => VERSION_NAME . '/' . VERSION_NUMBER,
};

# подробный man программы
sub usage_man() {
	use Pod::Man;

	my $parser = Pod::Man->new(
		center  => VERSION_NAME . " Manual",
		release => VERSION_NUMBER,
	);
	if ( open(my $man, "|man -l -") ) {
		$parser->parse_from_file(__FILE__, $man);
		close $man;
		exit 0;
	}
	else {
		warn "Can't create a pipe to man tool\n";
		warn "Try to execute:  pod2man '$0' | man -l -\n";
		exit 1;
	}
}

my (%opt, @branches, %branch_track);

sub process_info_options() {
	pod2usage(1)
		if defined $opt{help}
	;

	usage_man()
		if defined $opt{man}
	;

	say(VERSION) and exit(0)
		if defined $opt{version}
	;
}

sub load_options() {
	use Getopt::Long;

	Getopt::Long::Configure("bundling");

	%opt = (
		pull => 1,
		push => 0,
	);

	GetOptions(\%opt,
		"help|h|?",
		"man",
		"version",
		"pull!",
		"merge!",
		"push!",
	)
		or pod2usage(2)
	;

	process_info_options();

	@branches = @ARGV
		or pod2usage(2)
	;

	if (1 == scalar @branches) {
		$opt{merge} && die "E! You want --merge, but only one branch was passed\n";
	}

	unless ($opt{pull} || $opt{merge} || $opt{push}) {
		die "E! All actions are disabled. Nothing to do. Aborting\n";
	}
}

sub check_if_repository() {
	`git status --short`;
	$? && die "E! Not in Git repository. Aborting\n";
}

sub check_if_branches() {
	my $repo_branches = `git for-each-ref '--format=%(refname:short)%09%(upstream:short)' refs/heads`;
	$? && die "E! Unable to list existing branches. Aborted\n";

	my %unknown_branches = map { $_ => 1 } @branches;

	%branch_track = ();
	for my $line ( split /\n/, $repo_branches ) {
		# local-branch <TAB> remote/branch
		# local-branch <TAB>
		unless ($line =~ /^(?<local>\S+)\t(?<upstream>\S*)$/) {
			warn "W* Result of `git for-each-ref` did not match expectations. Ignore the line.\n";
			next;
		}
		my $local    = $+{local};
		my $upstream = $+{upstream};

		$branch_track{$local} = $upstream;
		delete $unknown_branches{$local};
	}

	if (%unknown_branches) {
		warn "E! There are no such branches in the repository:\n";
		warn "E!     * $_\n" for keys %unknown_branches;
		die  "E! Aborted\n";
	}
}

sub validate_asked() {
	check_if_repository();

	check_if_branches();
}

sub exec_direct($@) {
	my ($header, @xarg) = @_;

	my $end = '';
	if ($header) {
		print  "<<<<<----- $header ------------------------<<<<<\n";
		$end = ">>>>>----- $header ------------------------>>>>>\n";
	}

	my $pid = open(my $h, "|-", @xarg);

	if ($pid) {
		close $h;
		print $end if $end ne '';
	}
	else {
		print $end if $end ne '';
		die "Failed to open a pipe\n";
	}
}

sub perform_the_pull() {
}

sub perform_the_merge() {
}

sub perform_the_push() {
}

sub do_the_work() {
	$opt{pull}  && perform_the_pull();
	$opt{merge} && perform_the_merge();
	$opt{push}  && perform_the_push();
}


load_options();
validate_asked();
do_the_work();

__END__;

=pod

=head1 NAME

git-merge-sync - a tool for merging and syncronizing cascaded branches
in Git repository

=head1 SYNOPSIS

B<git-merge-sync> [I<options>] [B<-->[B<no>]B<pull>] [B<-->[B<no>]B<merge>] [B<-->[B<no>]B<push>] [B<-->] I<branch> ...

B<git-merge-sync> (B<-h> | B<-?> | B<--help> | B<--man> | B<--version>)

=head1 DESCRIPTION

=head1 OPTIONS

=over

=item B<-h>, B<-?>, B<--help>

Print short help about usage and exit.

=item B<--man>

Display full man and exit.

=item B<--merge>

Enable the merge action explicitly. At least to branches required for merging.
By default this option is disable when only one branch passed, and enabled for
multiple branches list.

=item B<--no-merge>, B<--nomerge>

Disable the merge action. See B<--merge> above.

=item B<--pull>

Enable the pull action explicitly. Currently this option is enabled by default
to work with up-to-date branches.

=item B<--no-pull>, B<--nopull>

Disable the pull action. See B<--pull> above.

=item B<--push>

Enable the push action. Currently this option is disabled by default. You should
to check the work result before pushing.

=item B<--no-push>, B<--nopush>

Disable the push action. See B<--push> above.

=item B<--version>

Print program version and exit.

=item I<branch>

Branches names for work on. At least one branch is required.

=back

=head1 AUTHORS

Copyright (C) 2013 Vovan-VE <vovan-ve@yandex.ru>

=cut
